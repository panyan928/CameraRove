#include <stdio.h>
#include <math.h>
#include <vector>
#include "gl\gl.h"
#include "TMUtil/tmtools.h"

#define M_PI 3.141592653

// 新增函数：绘制飞机图标
void drawAirplaneIcon(Vec2d  posMec, Vec2d center, float aircraftHeading, float viewportWidth, float viewportHeight) {
    double rotationRad = - aircraftHeading * M_PI / 180.0;
    double centerX = (center[0] - posMec[0]) * 2 / viewportWidth;
    double centerY = (center[1] - posMec[1]) * 2 / viewportHeight;
    //centerX = centerX * cos(rotationRad) - centerY * sin(rotationRad);
    //centerY = centerX * sin(rotationRad) + centerY * cos(rotationRad);

    // 保存模型视图矩阵
    glMatrixMode(GL_PROJECTION);
    glPushMatrix();
    glLoadIdentity();
    glOrtho(-1.0, 1.0, -1.0, 1.0, 0.0, 10.0);

    glMatrixMode(GL_MODELVIEW);
    glPushMatrix();
    glLoadIdentity();
    //gluLookAt(0, 0, 1, 0, 0, 0, 0, 1, 0);

    // 保存当前所有相关状态
    glPushAttrib(GL_CURRENT_BIT | GL_ENABLE_BIT);

    // 设置固定的飞机颜色（例如白色）
    glColor3f(1.0f, 1.0f, 1.0f); // 白色

    // 禁用可能影响颜色的状态
    glDisable(GL_LIGHTING);      // 禁用光照
    glDisable(GL_TEXTURE_2D);    // 禁用纹理
    glDisable(GL_BLEND);         // 禁用混合

    // 设置飞机渲染状态
    glDisable(GL_DEPTH_TEST);    // 确保飞机在最前
    glDisable(GL_CULL_FACE);     // 禁用面剔除

    // 设置飞机渲染状态
    glDisable(GL_DEPTH_TEST);     // 禁用深度测试（确保在最前面）
    glDisable(GL_BLEND);          // 禁用混合（使用不透明色）
    glDisable(GL_CULL_FACE);      // 禁用面剔除

    // 5. 计算缩放比例
    float aircraftScale = 1.5;

    //// 6. 计算航向角（弧度）
    //float headingRad = aircraftHeading * M_PI / 180.0f;

    // 变换步骤（实现以飞机为中心的缩放）：
    // 1. 将飞机位置移动到坐标系原点
    // 2. 执行缩放和旋转
    // 3. 移回屏幕位置
    //glTranslatef(x_ndc, y_ndc, 0.0f);      // 步骤3：移回
    glRotatef(aircraftHeading, 0.0f, 0.0f, 1.0f); // 旋转
    glTranslatef(-centerX, -centerY, 0.0f);    // 步骤1：移到原点

    
    glScalef(aircraftScale, aircraftScale, 1.0f); // 缩放
    // 进一步缩小坐标值
    glScalef(0.0001f, 0.0001f, 1.0f);

    // 替换顶点数据部分为新的飞机数据
    std::vector<GLfloat> vertices = {
        // First set of vertices
           -229.8762207f, 175.4812012f,
           -237.5363770f, 160.5925293f,
           -83.8049316f, 2.2529297f,
           -176.4226074f, 165.3974609f,
           -179.6904297f, 179.2180176f,
           -223.1274414f, 395.2353516f,
           -233.5747070f, 331.5615234f,
           -227.2873535f, -210.7246094f,
           -225.1835938f, -223.1545410f,
           -223.6892090f, -99.1652832f,
           -221.4370117f, -247.0869141f,
           -220.3132324f, -88.3190918f,
           -216.1796875f, -256.2727051f,
           -206.1604004f, -79.2456055f,
           -194.8493652f, -257.4633789f,
           -186.4333496f, -90.3864746f,
           -186.3291016f, -241.3601074f,
           -180.3696289f, -105.4057617f,
           -184.5163574f, -232.6984863f,
           -176.3588867f, -226.6264648f,
           -232.8527832f, -156.7431641f,
           -232.6623535f, -159.5493164f,
           -232.0612793f, -133.5529785f,
           -229.9907227f, -190.0007324f,
           -228.2204590f, -104.9777832f,
           -227.2873535f, -210.7246094f,
           -223.6892090f, -99.1652832f,
           -78.6818848f, 183.4211426f,
           -78.0712891f, 167.1835938f,
           -78.0454102f, 218.9160156f,
           -77.3735352f, 158.3347168f,
           -75.5317383f, 247.7473145f,
           -76.6757813f, 149.4855957f,
           -66.6604004f, -4.0895996f,
           -83.8049316f, 2.2529297f,

           // Second set of vertices
           178.1301270f, 324.0710449f,
           180.5429688f, 311.7988281f,
           180.7573242f, 386.5456543f,
           253.8239746f, 25.7963867f,
           188.1604004f, 397.3041992f,
           230.5800781f, 172.2180176f,
           228.7722168f, 185.0732422f,
           174.5097656f, 367.5109863f,
           173.5646973f, 346.8974609f,
           178.1301270f, 324.0710449f,
           180.7573242f, 386.5456543f,
           233.1030273f, 373.5107422f,
           225.9626465f, 391.0974121f,
           229.8818359f, 321.5881348f,
           232.7788086f, 329.5856934f,
           235.2231445f, 341.0949707f,
           235.5693359f, 356.6062012f,
           228.7722168f, 185.0732422f,
           229.0578613f, 251.1054688f,
           225.9626465f, 391.0974121f,
           212.9418945f, 401.9597168f,
           198.7658691f, 402.2700195f,
           188.1604004f, 397.3041992f,

           // Third set of vertices
           76.6757813f, 149.4855957f,
           78.7253418f, 189.0053711f,
           78.0454102f, 218.9160156f,
           75.0959473f, 251.8095703f,
           71.6879883f, -1.5952148f,
           83.8049316f, 2.2529297f,
           113.7377930f, 151.4187012f,
           596.6018066f, 77.8117676f,
           588.6330566f, 92.3918457f,
           598.2089844f, 72.8640137f,
           578.9230957f, 110.2705078f,
           574.0075684f, 69.5166016f,
           567.9409180f, 125.7082520f,
           556.5568848f, 134.8125000f,
           556.5568848f, 134.8125000f,
           545.3068848f, 139.5625000f,
           574.0075684f, 69.5166016f,
           533.1191406f, 141.8056641f,
           524.7475586f, 63.1584473f,
           517.5834961f, 143.2570801f,
           493.0288086f, 144.6542969f,
           479.7683105f, 57.1484375f,
           524.7475586f, 63.1584473f,
           493.0288086f, 144.6542969f,

           // Fourth set of vertices
           406.7810059f, 148.7500000f,
           335.9465332f, 152.4685059f,
           261.1369629f, 156.3911133f,
           253.8239746f, 25.7963867f,
           249.5437012f, 157.0437012f,
           230.5800781f, 172.2180176f,
           253.8239746f, 25.7963867f,
           261.1369629f, 156.3911133f,
           253.8239746f, 25.7963867f,
           180.5429688f, 311.7988281f,
           180.2363281f, 248.6103516f,
           179.9296875f, 182.6733398f,
           178.2558594f, 169.7165527f,
           164.4267578f, 156.0529785f,
           159.0463867f, 155.0322266f,
           138.2670898f, 153.4187012f,
           113.7377930f, 151.4187012f,
           83.8049316f, 2.2529297f,
           71.6879883f, -1.5952148f,
           75.0959473f, 251.8095703f,
           71.4423828f, 278.0649414f,
           67.1518555f, 299.3334961f,
           62.4082031f, 317.1357422f,
           62.1030273f, -6.7976074f,

           // Fifth set of vertices
           50.2863770f, -19.6965332f,
           52.1308594f, -15.6340332f,
           54.1374512f, 341.8334961f,
           54.5180664f, -12.8903809f,
           62.4082031f, 317.1357422f,
           62.1030273f, -6.7976074f,
           27.5759277f, -153.8125000f,
           27.7233887f, -147.2773438f,
           34.6081543f, 384.8391113f,
           38.7663574f, -84.6137695f,
           44.8830566f, 366.3874512f,
           50.2863770f, -19.6965332f,
           54.1374512f, 341.8334961f,
           20.3447266f, 396.4943848f,
           6.1364746f, 400.3071289f,
           7.7065430f, -336.7617188f,
           9.5646973f, -300.0571289f,
           12.7482910f, -289.8186035f,
           19.6801758f, -280.6442871f,
           26.2619629f, -275.0571289f,
           27.5759277f, -153.8125000f,
           34.6081543f, 384.8391113f,
           6.1364746f, 400.3071289f,
           0.0000000f, 400.7426758f,

           // Sixth set of vertices
           1.8679199f, -412.6647949f,
           5.5783691f, -378.5214844f,
           6.1213379f, -371.4787598f,
           7.7065430f, -336.7617188f,
           0.0000000f, 400.7426758f,
           -34.6081543f, 384.8391113f,
           -27.7233887f, -147.2773438f,
           -22.7609863f, -277.8161621f,
           -10.9279785f, -294.5783691f,
           -7.7065430f, -336.7617188f,
           -6.1213379f, -371.4787598f,
           -2.9990234f, -402.9924316f,
           -1.8679199f, -412.6647949f,
           -0.2868652f, -417.4487305f,
           1.8679199f, -412.6647949f,
           -27.7233887f, -147.2773438f,
           -34.6081543f, 384.8391113f,
           -38.7663574f, -84.6137695f,
           -49.6923828f, 354.5412598f,
           -53.0351563f, -14.3513184f,
           -63.4648438f, 313.4023438f,
           -66.6604004f, -4.0895996f,
           -71.4423828f, 278.0649414f,
           -75.5317383f, 247.7473145f,

           // Seventh set of vertices
           -83.8049316f, 2.2529297f,
           -76.6757813f, 149.4855957f,
           -159.0463867f, 155.0322266f,
           -166.0607910f, 156.5241699f,
           -176.4226074f, 165.3974609f,
           -198.7658691f, 402.2700195f,
           -223.1274414f, 395.2353516f,
           -179.6904297f, 179.2180176f,
           -180.2363281f, 248.6103516f,
           -180.5349121f, 313.3811035f,
           -180.7573242f, 386.5456543f,
           -253.8239746f, 25.7963867f,
           -83.8049316f, 2.2529297f,
           -237.5363770f, 160.5925293f,
           -254.4294434f, 156.7580566f,
           -406.7810059f, 148.7500000f,
           -506.6318359f, 143.8457031f,
           -524.7475586f, 63.1584473f,
           -524.7475586f, 63.1584473f,
           -506.6318359f, 143.8457031f,
           -549.1240234f, 138.2431641f,
           -570.3518066f, 122.8713379f,
           -588.6330566f, 92.3918457f,
           -596.6018066f, 77.8117676f,

           // Eighth set of vertices
           -597.1374512f, 76.7563477f,
           223.7194824f, -98.0266113f,
           223.1416016f, -91.6447754f,
           223.6586914f, -100.3039551f,
           225.1835938f, -223.1545410f,
           231.3923340f, -110.1748047f,
           229.8071289f, -196.6728516f,
           232.5280762f, -155.5031738f,
           206.8740234f, -258.7729492f,
           218.8083496f, -254.3974609f,
           220.3132324f, -88.3190918f,
           221.4370117f, -247.0869141f,
           223.1416016f, -91.6447754f,
           225.1835938f, -223.1545410f,
           202.3745117f, -77.6608887f,
           185.8249512f, -94.4611816f,
           186.3291016f, -241.3601074f,
           192.5529785f, -256.5703125f,
           197.8103027f, -258.3562012f,
           206.8740234f, -258.7729492f,
           220.3132324f, -88.3190918f,
           179.8159180f, -105.6787109f,
           177.2319336f, -112.1340332f,
           179.3801270f, -227.1621094f,

           // Ninth set of vertices
           186.3291016f, -241.3601074f,
           185.8249512f, -94.4611816f,
           177.2319336f, -112.1340332f,
           176.7705078f, -119.4985352f,
           179.3801270f, -227.1621094f,
           175.7092285f, -130.4545898f,
           175.2934570f, -226.5974121f,
           168.8337402f, -140.4560547f,
           156.9604492f, -145.9084473f,
           104.1315918f, -248.2141113f,
           175.2934570f, -226.5974121f,
           156.9604492f, -145.9084473f,
           103.9133301f, -153.2731934f,
           50.8662109f, -160.6379395f,
           40.1054688f, -161.9448242f,
           36.0583496f, -269.6281738f,
           36.0583496f, -269.6281738f,
           40.1054688f, -161.9448242f,
           28.3129883f, -157.6606445f,
           27.5759277f, -153.8125000f,
           26.2619629f, -275.0571289f,
           -28.7553711f, -158.8950195f,
           -44.6752930f, -161.5092773f,
           -36.0583496f, -269.6281738f,

           // Tenth set of vertices
           -22.7609863f, -277.8161621f,
           -27.7233887f, -147.2773438f,
           -103.9133301f, -153.2731934f,
           -156.9604492f, -145.9084473f,
           -104.1315918f, -248.2141113f,
           -36.0583496f, -269.6281738f,
           -44.6752930f, -161.5092773f,
           -170.3103027f, -139.2285156f,
           -176.7705078f, -119.4985352f,
           -176.3588867f, -226.6264648f,
           -104.1315918f, -248.2141113f,
           -156.9604492f, -145.9084473f,
           -177.2319336f, -112.1340332f,
           -180.3696289f, -105.4057617f,
           -176.3588867f, -226.6264648f,
           -176.7705078f, -119.4985352f,
           -173.5646973f, 346.8974609f,
           -180.7573242f, 386.5456543f,
           -180.5349121f, 313.3811035f,
           229.8818359f, 321.5881348f,
           225.9626465f, 391.0974121f,
           229.0578613f, 251.1054688f,
           -186.4333496f, -90.3864746f,
           -180.3696289f, -105.4057617f,

           // Final set of vertices
           -179.8159180f, -105.6787109f,
           -233.5747070f, 331.5615234f,
           -223.1274414f, 395.2353516f,
           -234.5314941f, 368.5380859f
    };
    // 7. 绘制飞机
     // 启用顶点数组
    glEnableClientState(GL_VERTEX_ARRAY);
    glVertexPointer(2, GL_FLOAT, 0, vertices.data());

    // 按照原始分组绘制所有部分
    glDrawArrays(GL_TRIANGLE_FAN, 0, 7);
    glDrawArrays(GL_TRIANGLE_STRIP, 7, 13);
    glDrawArrays(GL_TRIANGLE_STRIP, 20, 7);
    glDrawArrays(GL_TRIANGLE_STRIP, 27, 8);
    glDrawArrays(GL_TRIANGLE_STRIP, 35, 7);
    glDrawArrays(GL_TRIANGLE_FAN, 42, 4);
    glDrawArrays(GL_TRIANGLE_FAN, 46, 6);
    glDrawArrays(GL_TRIANGLE_FAN, 52, 6);
    glDrawArrays(GL_TRIANGLE_FAN, 58, 7);
    glDrawArrays(GL_TRIANGLE_STRIP, 65, 7);
    glDrawArrays(GL_TRIANGLE_STRIP, 72, 7);
    glDrawArrays(GL_TRIANGLE_FAN, 79, 7);
    glDrawArrays(GL_TRIANGLE_FAN, 86, 4);
    glDrawArrays(GL_TRIANGLE_FAN, 90, 10);
    glDrawArrays(GL_TRIANGLE_FAN, 100, 6);
    glDrawArrays(GL_TRIANGLE_STRIP, 106, 6);
    glDrawArrays(GL_TRIANGLE_STRIP, 112, 7);
    glDrawArrays(GL_TRIANGLE_FAN, 119, 9);
    glDrawArrays(GL_TRIANGLE_FAN, 128, 6);
    glDrawArrays(GL_TRIANGLE_FAN, 134, 11);
    glDrawArrays(GL_TRIANGLE_STRIP, 145, 9);
    glDrawArrays(GL_TRIANGLE_FAN, 154, 5);
    glDrawArrays(GL_TRIANGLE_FAN, 159, 6);
    glDrawArrays(GL_TRIANGLE_FAN, 165, 7);
    glDrawArrays(GL_TRIANGLE_FAN, 172, 7);
    glDrawArrays(GL_TRIANGLE_STRIP, 179, 7);
    glDrawArrays(GL_TRIANGLE_STRIP, 186, 6);
    glDrawArrays(GL_TRIANGLE_FAN, 192, 7);
    glDrawArrays(GL_TRIANGLE_FAN, 199, 5);
    glDrawArrays(GL_TRIANGLE_STRIP, 204, 7);
    glDrawArrays(GL_TRIANGLE_FAN, 211, 7);
    glDrawArrays(GL_TRIANGLE_FAN, 218, 5);
    glDrawArrays(GL_TRIANGLE_FAN, 223, 5);
    glDrawArrays(GL_TRIANGLE_FAN, 228, 5);
    glDrawArrays(GL_TRIANGLE_FAN, 233, 5);
    glDrawArrays(GL_TRIANGLE_FAN, 238, 4);
    glDrawArrays(GL_TRIANGLES, 242, 12);

    glDisableClientState(GL_VERTEX_ARRAY);

    // 恢复所有属性
    glPopAttrib();
    // 恢复矩阵
    glPopMatrix();
    // 恢复投影矩阵
    glMatrixMode(GL_PROJECTION);  // 切回投影矩阵
    glPopMatrix();                // 恢复投影矩阵

}